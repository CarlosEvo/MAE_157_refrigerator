%% TXV_3

results_TXV_3 = struct(...
    'P_1', [], 'v_1', [], 'H_1', [],...
    'P_2', [], 'v_2', [], 'H_2', [], 'x_2', [],...
    'P_3', [], 'v_3', [], 'H_3', [],...
    'P_3_g', [], 'v_3_g', [],...
    'P_4', [], 'v_4', [],...
    'v_4_ideal', [], 'T_4_ideal', [],...
    'v_4_work', [], 'T_4_work', [], 'H_4_work', [],...
    'P_5', [], 'v_5', []...
);

idx_6 = 9;

% #1: T1 gives specific volume (saturated liquid)
results_TXV_3.P_1 = data.P1(idx_6);
results_TXV_3.v_1 = interp1(R12_sat.T, R12_sat.v_f, data.T1(idx_6));
results_TXV_3.H_1 = interp1(R12_sat.T, R12_sat.H_f, data.T1(idx_6));

% #2: same enthalpy, T2 gives quality x
results_TXV_3.P_2 = data.P2(idx_6);
results_TXV_3.H_2 = results_TXV_3.H_1;
H_2_f = interp1(R12_sat.T, R12_sat.H_f, data.T2(idx_6));
H_2_g = interp1(R12_sat.T, R12_sat.H_g, data.T2(idx_6));
v_2_f = interp1(R12_sat.T, R12_sat.v_f, data.T2(idx_6));
v_2_g = interp1(R12_sat.T, R12_sat.v_g, data.T2(idx_6));
results_TXV_3.x_2 = quality(H_2_f, H_2_g, results_TXV_3.H_2);
results_TXV_3.v_2 = mix(v_2_f, v_2_g, results_TXV_3.x_2);

% #3_g: isobaric, isothermal
results_TXV_3.P_3_g = results_TXV_3.P_2;
results_TXV_3.v_3_g = interp1(R12_sat.P, R12_sat.v_g, data.P2(idx_6));

% #3: pressure table
results_TXV_3.P_3 = data.P3(idx_6);
[T, P] = meshgrid(R12_P_8.T, [290, 300] .* 1000);
results_TXV_3.v_3 = interp2(...
    T, P, [R12_P_8.v_290, R12_P_8.v_300].',...
    data.T4(idx_6), data.P3(idx_6)...
);
results_TXV_3.H_3 = interp2(...
    T, P, [R12_P_8.H_290, R12_P_8.H_300].',...
    data.T4(idx_6), data.P3(idx_6)...
);
results_TXV_3.S_3 = interp2(...
    T, P, [R12_P_8.S_290, R12_P_8.S_300].',...
    data.T4(idx_6), data.P3(idx_6)...
);

% #4
% Experimental Value
results_TXV_3.P_4 = data.P4(idx_6);
[T, P] = meshgrid(R12_P_16.T, [1200, 1300] .* 1000);
results_TXV_3.v_4 = interp2(...
    T, P,...
    [R12_P_16.v_1200, R12_P_16.v_1300].',...
    data.T5(idx_6), data.P4(idx_6)...
);

% Value based on work done by compressor (use H & P)
results_TXV_3.H_4_work = results_TXV_3.H_3 + 600 ./ data.mass(idx_6);
results_TXV_3.T_4_work = fzero(...
    @(T_4_work) interp2(...
        T, P,...
        [R12_P_16.H_1200, R12_P_16.H_1300].',...
        T_4_work, data.P4(idx_6)...
    ) - results_TXV_3.H_4_work,...
    data.T5(idx_6) + 50 ...
);
results_TXV_3.v_4_work = interp2(...
    T, P,...
    [R12_P_16.v_1200, R12_P_16.v_1300].',...
    results_TXV_3.T_4_work, data.P4(idx_6)...
);

% Ideal value
results_TXV_3.S_4_ideal = results_TXV_3.S_3;
results_TXV_3.T_4_ideal = fzero(...
    @(T_4_ideal) interp2(...
        T, P,...
        [R12_P_16.S_1200, R12_P_16.S_1300].',...
        T_4_ideal, data.P4(idx_6)...
    ) - results_TXV_3.S_4_ideal,...
    data.T5(idx_6) + 10 ...
);
results_TXV_3.v_4_ideal = interp2(...
    T, P,...
    [R12_P_16.v_1200, R12_P_16.v_1300].',...
    results_TXV_3.T_4_ideal, data.P4(idx_6)...
);

% #5: isobaric, isothermal
results_TXV_3.P_5 = results_TXV_3.P_1;
results_TXV_3.v_5 = interp1(R12_sat.P, R12_sat.v_g, data.P1(idx_6));

% H-S Diagram
fig = figure;
hold on;

% Experimental cycle
plot(...
    [...
        results_TXV_3.v_1, results_TXV_3.v_2, results_TXV_3.v_3_g, results_TXV_3.v_3,...
        results_TXV_3.v_4, results_TXV_3.v_5, results_TXV_3.v_1...
    ],...
    [...
        results_TXV_3.P_1, results_TXV_3.P_2, results_TXV_3.P_3_g, results_TXV_3.P_3,...
        results_TXV_3.P_4, results_TXV_3.P_5, results_TXV_3.P_1...
    ],...
    'o-'...
);
text(...
    [...
        results_TXV_3.v_1, results_TXV_3.v_2, results_TXV_3.v_3_g,...
        results_TXV_3.v_3, results_TXV_3.v_4, results_TXV_3.v_5,...
    ],...
    [...
        results_TXV_3.P_1, results_TXV_3.P_2, results_TXV_3.P_3_g,...
        results_TXV_3.P_3, results_TXV_3.P_4, results_TXV_3.P_5...
    ] + 5e4,...
    {'1', '2', '3''', '3', '4', '5'}...
);

% Ideal cycle
plot(...
    [results_TXV_3.v_3, results_TXV_3.v_4_ideal, results_TXV_3.v_5],...
    [results_TXV_3.P_3, results_TXV_3.P_4, results_TXV_3.P_5],...
    'o--'...
);
text(results_TXV_3.v_4_ideal, results_TXV_3.P_4 + 5e4, '4''');

% Work cycle
plot(...
    [results_TXV_3.v_3, results_TXV_3.v_4_work, results_TXV_3.v_5],...
    [results_TXV_3.P_3, results_TXV_3.P_4, results_TXV_3.P_5],...
    'o--'...
);
text(results_TXV_3.v_4_work, results_TXV_3.P_4 + 5e4, '4''''');

% Saturation dome
plot(...
    [R12_sat.v_f; R12_sat.v_g(end: -1: 1)],...
    [R12_sat.P; R12_sat.P(end: -1: 1)],...
    '-'...
);
formatFig(...
    fig, 'figures/TXV_3_HS',...
    'XLabel', 'Specific Volume $v\ (m^3 / kg)$',...
    'YLabel', 'Pressure $P\ (Pa)$',...
    'XLim', [0, 0.075],...
    'YLim', [0, 2e6],...
    'axisScale', 'linear',...
    'legends', {'Experimental Cycle', 'Ideal Cycle', 'Compressor Cycle', 'Saturation Dome'}...
);
close(fig);

results_TXV_3 = struct2table(results_TXV_3);
